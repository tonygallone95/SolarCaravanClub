name: ğŸš€ Auto Publish Articles

on:
  workflow_dispatch:
    inputs:
      publish_status:
        description: 'ğŸ“ Publish Status'
        required: true
        default: 'draft'
        type: choice
        options:
          - draft
          - publish
      html_file:
        description: 'ğŸ“„ HTML file to publish (e.g., article.html)'
        required: false
        default: ''
        type: string
      post_title:
        description: 'ğŸ“° Post Title'
        required: false
        default: ''
        type: string

jobs:
  auto-publish:
    runs-on: ubuntu-latest
    name: ğŸ“¤ Publish Article to WordPress
    
    steps:
      # ========================================
      # SETUP PHASE
      # ========================================
      
      - name: ğŸ Start Publishing Process
        run: |
          echo "========================================="
          echo "ğŸš€ WORDPRESS ARTICLE PUBLISHER"
          echo "========================================="
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ“ Status: ${{ github.event.inputs.publish_status }}"
          echo "ğŸ“„ File: ${{ github.event.inputs.html_file || 'Auto-detect' }}"
          echo "ğŸ“° Title: ${{ github.event.inputs.post_title || 'Auto-generate' }}"
          echo "========================================="
      
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      
      - name: ğŸ” Verify Repository Structure
        run: |
          echo "ğŸ“‚ Repository Contents:"
          echo "========================================="
          tree -L 2 2>/dev/null || ls -la
          echo "========================================="
          echo ""
          echo "ğŸ“Š Repository Stats:"
          echo "Total files: $(find . -type f | wc -l)"
          echo "HTML files: $(find . -name "*.html" | wc -l)"
          echo "JSON files: $(find . -name "*.json" | wc -l)"
      
      # ========================================
      # ENVIRONMENT SETUP
      # ========================================
      
      - name: ğŸ Set up Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: ğŸ“¦ Cache Python Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: ğŸ”§ Install Dependencies
        run: |
          echo "ğŸ“¦ Installing Python dependencies..."
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 python-dotenv colorama
          echo ""
          echo "âœ… Installed packages:"
          pip list | grep -E "(requests|beautifulsoup4|python-dotenv|colorama)"
      
      # ========================================
      # VALIDATION PHASE
      # ========================================
      
      - name: ğŸ” Validate Secrets
        run: |
          echo "ğŸ”’ Checking WordPress credentials..."
          if [ -z "${{ secrets.WP_SITE }}" ]; then
            echo "âŒ ERROR: WP_SITE secret is missing!"
            exit 1
          else
            echo "âœ… WP_SITE is configured"
          fi
          
          if [ -z "${{ secrets.WP_USER }}" ]; then
            echo "âŒ ERROR: WP_USER secret is missing!"
            exit 1
          else
            echo "âœ… WP_USER is configured"
          fi
          
          if [ -z "${{ secrets.WP_APP_PASS }}" ]; then
            echo "âŒ ERROR: WP_APP_PASS secret is missing!"
            exit 1
          else
            echo "âœ… WP_APP_PASS is configured"
          fi
          
          echo ""
          echo "ğŸ¯ Target Site: ${{ secrets.WP_SITE }}"
      
      - name: ğŸ“‹ Scan for Content Files
        id: scan_content
        run: |
          echo "ğŸ” Scanning for publishable content..."
          echo "========================================="
          
          # Find HTML files
          echo "ğŸ“„ HTML Files Found:"
          if find . -name "*.html" -type f | grep -v node_modules | head -10; then
            HTML_COUNT=$(find . -name "*.html" -type f | grep -v node_modules | wc -l)
            echo "Total: $HTML_COUNT HTML files"
            echo "html_count=$HTML_COUNT" >> $GITHUB_OUTPUT
          else
            echo "âŒ No HTML files found"
            echo "html_count=0" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "ğŸ“Š JSON Files Found:"
          if find . -name "*.json" -type f | grep -v node_modules | grep -v package | head -10; then
            JSON_COUNT=$(find . -name "*.json" -type f | grep -v node_modules | grep -v package | wc -l)
            echo "Total: $JSON_COUNT JSON files"
            echo "json_count=$JSON_COUNT" >> $GITHUB_OUTPUT
          else
            echo "âŒ No JSON files found"
            echo "json_count=0" >> $GITHUB_OUTPUT
          fi
          
          echo "========================================="
      
      - name: ğŸ¯ Determine Target File
        id: target_file
        run: |
          echo "ğŸ¯ Determining target file..."
          
          if [ -n "${{ github.event.inputs.html_file }}" ]; then
            TARGET_FILE="${{ github.event.inputs.html_file }}"
            echo "ğŸ“Œ Using specified file: $TARGET_FILE"
          else
            echo "ğŸ” Auto-detecting most recent HTML file..."
            TARGET_FILE=$(find . -name "*.html" -type f | grep -v node_modules | xargs ls -t | head -1)
            if [ -n "$TARGET_FILE" ]; then
              echo "ğŸ“Œ Found: $TARGET_FILE"
            else
              echo "âŒ No HTML files found for auto-detection"
              exit 1
            fi
          fi
          
          echo "target_file=$TARGET_FILE" >> $GITHUB_OUTPUT
          
          # Show file preview
          echo ""
          echo "ğŸ“„ File Preview:"
          echo "========================================="
          head -20 "$TARGET_FILE" | sed 's/^/  /'
          echo "========================================="
          echo "ğŸ“ File size: $(du -h "$TARGET_FILE" | cut -f1)"
          echo "ğŸ“… Last modified: $(date -r "$TARGET_FILE" 2>/dev/null || stat -c %y "$TARGET_FILE" 2>/dev/null || echo 'Unknown')"
      
      # ========================================
      # PUBLISHING PHASE
      # ========================================
      
      - name: ğŸš€ Execute Publishing Script
        id: publish
        env:
          WP_SITE: ${{ secrets.WP_SITE }}
          WP_USER: ${{ secrets.WP_USER }}
          WP_APP_PASS: ${{ secrets.WP_APP_PASS }}
          PUBLISH_STATUS: ${{ github.event.inputs.publish_status }}
          HTML_FILE: ${{ steps.target_file.outputs.target_file }}
          POST_TITLE: ${{ github.event.inputs.post_title }}
        run: |
          echo "ğŸš€ Starting WordPress publishing..."
          echo "========================================="
          echo "ğŸ“¤ Publishing to: $WP_SITE"
          echo "ğŸ‘¤ User: $WP_USER"
          echo "ğŸ“ Status: $PUBLISH_STATUS"
          echo "ğŸ“„ File: $HTML_FILE"
          echo "========================================="
          echo ""
          
          # Run the publishing script with error handling
          if python post.py; then
            echo "âœ… Publishing script completed successfully"
            echo "publish_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Publishing script failed with exit code: $?"
            echo "publish_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      # ========================================
      # RESULTS PHASE
      # ========================================
      
      - name: ğŸ“Š Process Publishing Results
        if: always()
        run: |
          echo "ğŸ“Š PUBLISHING RESULTS"
          echo "========================================="
          
          if [ -f "publish_result.json" ]; then
            echo "âœ… Result file found"
            echo ""
            echo "ğŸ“‹ Raw Results:"
            cat publish_result.json | python -m json.tool || cat publish_result.json
            echo ""
            
            # Extract key information if possible
            if command -v jq >/dev/null 2>&1; then
              echo "ğŸ“Œ Key Information:"
              echo "Post ID: $(jq -r '.id // "N/A"' publish_result.json)"
              echo "Post URL: $(jq -r '.link // "N/A"' publish_result.json)"
              echo "Status: $(jq -r '.status // "N/A"' publish_result.json)"
            fi
          else
            echo "âŒ No result file found (publish_result.json)"
          fi
          
          echo "========================================="
      
      - name: ğŸ“ Generate Summary Report
        if: always()
        run: |
          echo "## ğŸ“ Publishing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸš€ Status | ${{ steps.publish.outputs.publish_status || 'Unknown' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“… Date | $(date) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ‘¤ User | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“ Publish Mode | ${{ github.event.inputs.publish_status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“„ File | ${{ steps.target_file.outputs.target_file || 'Not found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“Š HTML Files | ${{ steps.scan_content.outputs.html_count || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“Š JSON Files | ${{ steps.scan_content.outputs.json_count || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "publish_result.json" ]; then
            echo "### ğŸ¯ WordPress Response" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat publish_result.json | python -m json.tool >> $GITHUB_STEP_SUMMARY 2>/dev/null || cat publish_result.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸ‰ Final Status
        if: always()
        run: |
          echo ""
          echo "========================================="
          if [ "${{ steps.publish.outputs.publish_status }}" == "success" ]; then
            echo "âœ… ğŸ‰ PUBLISHING COMPLETED SUCCESSFULLY!"
          else
            echo "âŒ ğŸ˜ PUBLISHING FAILED"
          fi
          echo "========================================="
          echo ""
          echo "ğŸ“Œ Check the summary tab for detailed results"
